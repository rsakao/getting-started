タスクリストがコンテナを起動するたびに消去されるのは分かりましたか？なぜでしょうか？それでは、コンテナの動作方法について調べてみましょう。

## コンテナのファイルシステム

コンテナが実行されると、イメージから各レイヤーを使用してファイルシステムを構築します。各コンテナには、ファイルを作成/更新/削除するための "スクラッチスペース" があります。どのコンテナからもこれらの変更は見えません。たとえ同じイメージを使用している場合でもです。

### 実践で確認

これを確認するには、2つのコンテナを起動し、それぞれにファイルを作成します。1つのコンテナで作成されたファイルは、他のコンテナでは利用できないことがわかります。

1. `/ data.txt` という名前のファイルを作成し、1〜10000のランダムな数値を含める `ubuntu` コンテナを開始します。

    ```bash
    docker run -d ubuntu bash -c "shuf -i 1-10000 -n 1 -o /data.txt && tail -f /dev/null"
    ```

    コマンドが気になる場合は、 bash シェルを開始し、2つのコマンドを実行する方法について(なぜ `&&` を使用するのか)説明します。最初の部分は1つのランダムな数字を選択し、それを `/data.txt` に書き込みます。2番目のコマンドは、単純にコンテナを実行し続けるためのファイルを監視しています。

1. `exec` コマンドを使って出力を表示できることを確認します。`Dashboard` を開き、Ubuntu コンテナを見つけ、「トリプルドット」メニューをクリックし、追加のアクションを取得して、「ターミナルで開く」メニュー項目をクリックします。

    ![Dashboard open CLI into ubuntu container](dashboard-open-cli-ubuntu.png){: style=width:75% }

    Ubuntu コンテナで実行されているシェルが表示されます。次のコマンドを実行して `/data.txt` ファイルの内容を表示します。その後、このターミナルを閉じてください。

    ```bash
    cat /data.txt
    ```

    `docker exec` コマンドを使用した場合は、次のコマンドを使用してコンテナのIDを取得し、内容を取得します。

    ```bash
    docker exec <container-id> cat /data.txt
    ```

    ランダムな数値が表示されるはずです！

1. 今度は、**同じイメージ** を使用して別の `ubuntu` コンテナを起動し、さっき作成したファイルが存在しないことを確認します。

    ```bash
    docker run -it ubuntu ls /
    ```

    `data.txt` ファイルが存在しないことが確認できます。それは最初のコンテナのスクラッチ空間に書き込まれたからです。

1. 最初のコンテナを `docker rm -f <container-id>` コマンドを使用して削除します。

## コンテナボリューム

前の実験で、コンテナが再起動するたびにイメージ定義から開始されることがわかりました。コンテナはファイルを作成、更新、削除できますが、コンテナが削除されると変更は失われます。すべての変更はそのコンテナに限定されるためです。ボリュームを使用すると、これをすべて変更できます。

[ボリューム](https://docs.docker.com/storage/volumes/)を使用すると、コンテナの特定のファイルシステムパスをホストマシンに接続できます。コンテナ内のディレクトリがマウントされている場合、そのディレクトリでの変更はホストマシンでも確認できます。同じディレクトリを複数のコンテナでマウントする場合、同じファイルが見えるはずです。

主要なボリュームには2つのタイプがあります。両方を使用する予定ですが、最初は **名前付きボリューム** を使用します。

## Todo データを永続化する

Todo アプリは、デフォルトでは `/etc/todos/todo.db` にある [SQLite データベース](https://www.sqlite.org/index.html) にデータを格納します。SQLite に馴染みがなくても心配しないでください！それは単に関係型データベースで、すべてのデータが単一のファイルに格納されているだけです。大規模なアプリケーションには向いていませんが、小さなデモには適しています。後でこれを別のデータベースエンジンに変更することについて話しましょう。

データベースが単一のファイルであるため、ホスト上でそのファイルを永続化し、次のコンテナで使用できるようにする必要があります。ボリュームを作成し、データが格納されているディレクトリにアタッチ (しばしば「マウント」と呼ばれる) することで、データを永続化できます。コンテナが `todo.db` ファイルに書き込むと、ボリュームに保存されます。

名前付きボリュームを使用します。名前付きボリュームは、単にデータのバケットと考えることができます。Docker は物理的な場所をディスク上に保持し、あなたはボリュームの名前だけを覚える必要があります。毎回ボリュームを使用すると、Docker が正しいデータを提供するようになります。

1. `docker volume create` コマンドを使用してボリュームを作成します。

    ```bash
    docker volume create todo-db
    ```

1. Dashboard で todo アプリのコンテナを再度停止します(`docker rm -f <container-id>` を使用することもできます)。

1. `-v` フラグを追加して `todo-db:/etc/todos` に名前付きボリュームをマウントし、コンテナを開始します。

    ```bash
    docker run -dp 3000:3000 -v todo-db:/etc/todos getting-started
    ```

1. コンテナが起動したら、アプリを開いて、Todo リストにアイテムを追加します。

    ![Items added to todo list](items-added.png){: style="width: 55%; " }
    {: .text-center }

1. todo アプリのコンテナを削除します。Dashboard または `docker ps`を使用して ID を取得し、`docker rm -f <container-id>` を使用して削除します。

1. もう一度上記と同じコマンドを使用して新しいコンテナを開始します。

1. アプリを開いてください。アイテムが引き継がれているはずです！

1. Todo リストを確認したら、コンテナを削除してください。

おめでとうございます！データの永続化方法を学びました！

!!! info "プロのアドバイス"
    デフォルトの Docker エンジンインストールでサポートされている2つのメインボリュームタイプは名前付きボリュームとバインドマウントですが、NFS、SFTP、NetApp などをサポートする多数のボリュームドライバプラグインも利用可能です。これは、Swarm、Kubernetes などのクラスタ環境で複数のホストでコンテナを実行し始めた場合に特に重要になります。

## ボリュームについて

多くの人々は「Docker は名前付きボリュームを使用してデータを保存する場合、実際にどこにデータを保存しているのか？」とよく尋ねます。知りたい場合は、 `docker volume inspect` コマンドを使用できます。

```bash
docker volume inspect todo-db
[
    {
        "CreatedAt": "2019-09-26T02:18:36Z",
        "Driver": "local",
        "Labels": {},
        "Mountpoint": "/var/lib/docker/volumes/todo-db/_data",
        "Name": "todo-db",
        "Options": {},
        "Scope": "local"
    }
]
```

`Mountpoint` は実際のディスク上の場所です。ほとんどのマシンでは、ホストからこのディレクトリにアクセスするには root アクセスが必要です。それがあなたのデータが保存されている場所です！

!!! info "Docker Desktop 上での直接ボリュームデータへのアクセス"
    Docker Desktop で実行する場合、Docker コマンドは実際にはマシン上の小さな VM 内で実行されています。
     Mountpoint ディレクトリの実際の内容を確認したい場合は、まず VM の中に入る必要があります。

## まとめ

この時点で、再起動しても機能するアプリケーションを持っています！投資家に披露して、私たちのビジョンを理解してもらえるといいですね！

ただ、前述したように、毎回変更のためにイメージを再構築するのは時間がかかります。何か改善できる方法はないでしょうか？バインドマウント(以前示唆していた方法)があります！今すぐチェックしてみましょう！